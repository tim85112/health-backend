åŠ å¯†

æ­¥é©Ÿ1.
JWTèªè­‰å’Œå¯†ç¢¼åŠ å¯†åŠŸèƒ½ï¼Œé¦–å…ˆéœ€è¦æ·»åŠ ç›¸é—œä¾è³´ã€‚ç„¶å¾Œå¯¦ä½œä»¥ä¸‹å¹¾å€‹é¡ï¼š
é¦–å…ˆéœ€è¦åœ¨pom.xmlä¸­æ·»åŠ JWTå’ŒSpring Securityä¾è³´ï¼š

<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-api</artifactId>
			<version>0.11.5</version>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-impl</artifactId>
			<version>0.11.5</version>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-jackson</artifactId>
			<version>0.11.5</version>
			<scope>runtime</scope>
		</dependency>

æ­¥é©Ÿ2.
é¦–å…ˆå‰µå»ºå®‰å…¨é…ç½®é¡
package com.example.demo.config;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

import com.example.demo.security.JwtAuthenticationFilter;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Autowired
    private JwtAuthenticationFilter jwtAuthFilter;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .csrf(csrf -> csrf.disable())
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/api/auth/**").permitAll()
                        .anyRequest().authenticated())
                .sessionManagement(session -> session
                        .sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }
}

æ­¥é©Ÿ3.JwtUtil é¡
package com.example.demo.security;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Component;

import java.nio.charset.StandardCharsets;
import java.security.Key;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Function;

@Component
public class JwtUtil {

    @Value("${jwt.secret:é»˜èªå¯†é‘°éœ€è¦æ›´é•·ä¸€äº›ä»¥æ»¿è¶³å®‰å…¨è¦æ±‚}")
    private String secret;

    @Value("${jwt.expiration:86400000}")
    private long expiration; // é»˜èª24å°æ™‚

    private Key getSigningKey() {
        byte[] keyBytes = secret.getBytes(StandardCharsets.UTF_8);
        return Keys.hmacShaKeyFor(keyBytes);
    }

    public String extractUsername(String token) {
        return extractClaim(token, Claims::getSubject);
    }

    public Date extractExpiration(String token) {
        return extractClaim(token, Claims::getExpiration);
    }

    public <T> T extractClaim(String token, Function<Claims, T> claimsResolver) {
        final Claims claims = extractAllClaims(token);
        return claimsResolver.apply(claims);
    }

    private Claims extractAllClaims(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(getSigningKey())
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    private Boolean isTokenExpired(String token) {
        return extractExpiration(token).before(new Date());
    }

    public String generateToken(UserDetails userDetails) {
        Map<String, Object> claims = new HashMap<>();
        return createToken(claims, userDetails.getUsername());
    }

    private String createToken(Map<String, Object> claims, String subject) {
        return Jwts.builder()
                .setClaims(claims)
                .setSubject(subject)
                .setIssuedAt(new Date(System.currentTimeMillis()))
                .setExpiration(new Date(System.currentTimeMillis() + expiration))
                .signWith(getSigningKey(), SignatureAlgorithm.HS256)
                .compact();
    }

    public Boolean validateToken(String token, UserDetails userDetails) {
        final String username = extractUsername(token);
        return (username.equals(userDetails.getUsername()) && !isTokenExpired(token));
    }
}

æ­¥é©Ÿ4.å‰µå»º JWT èªè­‰éæ¿¾å™¨ï¼š
package com.example.demo.security;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Autowired
    private JwtUtil jwtUtil;

    @Autowired
    private UserDetailsService userDetailsService;

    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain) throws ServletException, IOException {
        final String authHeader = request.getHeader("Authorization");
        final String jwt;
        final String userEmail;

        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            filterChain.doFilter(request, response);
            return;
        }

        jwt = authHeader.substring(7);
        userEmail = jwtUtil.extractUsername(jwt);

        if (userEmail != null && SecurityContextHolder.getContext().getAuthentication() == null) {
            UserDetails userDetails = this.userDetailsService.loadUserByUsername(userEmail);
            if (jwtUtil.validateToken(jwt, userDetails)) {
                UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                        userDetails,
                        null,
                        userDetails.getAuthorities());
                authToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                SecurityContextHolder.getContext().setAuthentication(authToken);
            }
        }
        filterChain.doFilter(request, response);
    }
}

æ­¥é©Ÿ5.å‰µå»ºUserDetailsServiceå¯¦ç¾ï¼š
package com.example.demo.security;

import com.example.demo.model.User;
import com.example.demo.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.Collections;

@Service
public class CustomUserDetailsService implements UserDetailsService {

    @Autowired
    private UserRepository userRepository;

    @Override
    public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException {
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new UsernameNotFoundException("æ‰¾ä¸åˆ°ä½¿ç”¨è€…: " + email));

        return new org.springframework.security.core.userdetails.User(
                user.getEmail(),
                user.getPassword(),
                Collections.singletonList(new SimpleGrantedAuthority("ROLE_" + user.getRole())));
    }
}

æ­¥é©Ÿ6.ä¿®æ”¹UserRepositoryæ·»åŠ findByEmailæ–¹æ³•ï¼š
package com.example.demo.repository;

import com.example.demo.model.User;

import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

//å®šç¾©ä»‹é¢ ç¹¼æ‰¿JPAçš„Repository
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByEmail(String email);
}

æ­¥é©Ÿ7.å‰µå»ºèªè­‰æœå‹™ï¼š

package com.example.demo.service;

import com.example.demo.model.User;
import com.example.demo.repository.UserRepository;
import com.example.demo.security.JwtUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

@Service
public class AuthService {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Autowired
    private JwtUtil jwtUtil;

    @Autowired
    private AuthenticationManager authenticationManager;

    @Autowired
    private UserDetailsService userDetailsService;

    public String register(User user) {
        // æª¢æŸ¥emailæ˜¯å¦å·²å­˜åœ¨
        if (userRepository.findByEmail(user.getEmail()).isPresent()) {
            throw new RuntimeException("è©²é›»å­ä¿¡ç®±å·²è¢«è¨»å†Š");
        }

        // åŠ å¯†å¯†ç¢¼
        user.setPassword(passwordEncoder.encode(user.getPassword()));

        // ä¿å­˜ç”¨æˆ¶
        userRepository.save(user);

        // ç”ŸæˆJWTä»¤ç‰Œ
        UserDetails userDetails = userDetailsService.loadUserByUsername(user.getEmail());
        return jwtUtil.generateToken(userDetails);
    }

    public String login(String email, String password) {
        // é©—è­‰ç”¨æˆ¶æ†‘è­‰
        authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(email, password));

        // ç”ŸæˆJWTä»¤ç‰Œ
        UserDetails userDetails = userDetailsService.loadUserByUsername(email);
        return jwtUtil.generateToken(userDetails);
    }
}


æ­¥é©Ÿ8.å‰µå»ºèªè­‰æ§åˆ¶å™¨ï¼š
package com.example.demo.controller;

import com.example.demo.model.User;
import com.example.demo.service.AuthService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping("/api/auth")
public class AuthController {

    @Autowired
    private AuthService authService;

    @PostMapping("/register")
    public ResponseEntity<?> register(@RequestBody User user) {
        try {
            String token = authService.register(user);
            Map<String, String> response = new HashMap<>();
            response.put("token", token);
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, String> errorResponse = new HashMap<>();
            errorResponse.put("error", e.getMessage());
            return ResponseEntity.badRequest().body(errorResponse);
        }
    }

    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody Map<String, String> loginRequest) {
        try {
            String email = loginRequest.get("email");
            String password = loginRequest.get("password");
            String token = authService.login(email, password);
            Map<String, String> response = new HashMap<>();
            response.put("token", token);
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, String> errorResponse = new HashMap<>();
            errorResponse.put("error", "èªè­‰å¤±æ•—ï¼š" + e.getMessage());
            return ResponseEntity.badRequest().body(errorResponse);
        }
    }
}

æ­¥é©Ÿ9. åœ¨application.propertiesä¸­æ·»åŠ JWTé…ç½®ï¼š

# JWTé…ç½®
jwt.secret=7DwAPKpz9h2wR4fVkRuNnGtWYT7A5LSBq8Xe3vDFGJjsUQZXyYRPLnHMTcVb
jwt.expiration=86400000

10.ä¿®æ”¹userè¡¨

package com.example.demo.model;

import jakarta.persistence.*;

@Entity
@Table(name = "users")
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    @Column(unique = true)
    private String email;

    private String password;

    private String role = "USER"; // é»˜èªè§’è‰²

    // getters and setters
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getRole() {
        return role;
    }

    public void setRole(String role) {
        this.role = role;
    }

}


11.æ¸¬è©¦login/register
{
  "name": "æ¸¬è©¦ç”¨æˆ¶",
  "email": "test@example.com",
  "password": "password123"
}

{
  "email": "test@example.com",
  "password": "password123"
}


12.ä¸²å‰ç«¯
12-1.å»ºäº†å…¨å±€CORSé…ç½®ï¼Œå…è¨±ä¾†è‡ªå‰ç«¯è·¨åŸŸè«‹æ±‚ã€‚

package com.example.demo.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOrigins("http://localhost:5173") // å‰ç«¯æ‡‰ç”¨çš„æº
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(true);
    }
}


12-2
ä¿®æ”¹SecurityConfigé¡ï¼šä¿®æ”¹äº†Spring Securityé…ç½®ï¼Œæ·»åŠ äº†CORSæ”¯æŒï¼Œç¢ºä¿å®‰å…¨éæ¿¾å™¨ä¸æœƒé˜»æ­¢é æª¢(preflight)è«‹æ±‚ã€‚

package com.example.demo.config;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import com.example.demo.security.JwtAuthenticationFilter;

import java.util.Arrays;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Autowired
    private JwtAuthenticationFilter jwtAuthFilter;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .cors(cors -> cors.configurationSource(corsConfigurationSource()))
                .csrf(csrf -> csrf.disable())
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/api/auth/**").permitAll()
.requestMatchers("/users/**").permitAll()
                        .requestMatchers("/posts/**").permitAll()
                        .anyRequest().authenticated())
                .sessionManagement(session -> session
                        .sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("http://localhost:5173"));
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        configuration.setAllowedHeaders(Arrays.asList("Authorization", "Content-Type", "X-Requested-With"));
        configuration.setAllowCredentials(true);
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }
}


ä¿®æ”¹å‰ç«¯

<template>
  <div style="padding: 20px">
    <!-- è¨»å†Šèˆ‡ç™»å…¥å€å¡Š -->
    <h2 style="margin-top: 30px">ç”¨æˆ¶è¨»å†Š</h2>
    <input v-model="registerName" placeholder="å§“å" />
    <input v-model="registerEmail" placeholder="Email" />
    <input v-model="registerPassword" placeholder="å¯†ç¢¼" />
    <button @click="register">è¨»å†Š</button>
    
    <h2 style="margin-top: 30px">ç”¨æˆ¶ç™»å…¥</h2>
    <input v-model="loginEmail" placeholder="Email" />
    <input v-model="loginPassword" placeholder="å¯†ç¢¼" />
    <button @click="login">ç™»å…¥</button>
    
    <div v-if="authToken" style="margin-top: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
      <p>å·²ç™»å…¥æˆåŠŸï¼</p>
      <p>Token: {{ authToken.substring(0, 20) }}...</p>
      <button @click="logout">ç™»å‡º</button>
    </div>

    <h1>ä½¿ç”¨è€…æ¸…å–®</h1>
    <ul>
      <!-- v-for è¿´åœˆæ¸²æŸ“æ¯å€‹ä½¿ç”¨è€… -->
      <li v-for="user in users" :key="user.id">
        <!-- è‹¥è©²ä½¿ç”¨è€…æ­£åœ¨ç·¨è¼¯ï¼Œé¡¯ç¤ºè¼¸å…¥æ¡† -->
        <template v-if="editingUserId === user.id">
          <input v-model="editName" placeholder="å§“å" />
          <input v-model="editEmail" placeholder="Email" />
          <input v-model="editPassword" placeholder="å¯†ç¢¼" />
          <button @click="updateUser(user.id)">å„²å­˜</button>
          <button @click="cancelEdit">å–æ¶ˆ</button>
        </template>
        <!-- å¦å‰‡é¡¯ç¤ºä¸€èˆ¬è³‡è¨Šèˆ‡æ“ä½œæŒ‰éˆ• -->
        <template v-else>
          {{ user.name }} - {{ user.email }}
          <button @click="startEdit(user)">ç·¨è¼¯</button>
          <button @click="deleteUser(user.id)">åˆªé™¤</button>
        </template>
      </li>
    </ul>

    <!-- æ–°å¢ä½¿ç”¨è€…å€å¡Š -->
    <h2 style="margin-top: 30px">æ–°å¢ä½¿ç”¨è€…</h2>
    <input v-model="name" placeholder="å§“å" />
    <input v-model="email" placeholder="Email" />
    <input v-model="password" placeholder="å¯†ç¢¼" />
    <button @click="createUser">é€å‡º</button>

    <!-- æ–°å¢è²¼æ–‡å€å¡Š -->
    <h2 style="margin-top: 30px">æ–°å¢è²¼æ–‡</h2>
    <input v-model="postUserId" placeholder="ä½¿ç”¨è€… ID" />
    <input v-model="postContent" placeholder="è²¼æ–‡å…§å®¹" />
    <button @click="createPost">é€å‡º</button>

    <h2 style="margin-top: 30px">è²¼æ–‡åˆ—è¡¨</h2>
    <ul>
      <li v-for="post in posts" :key="post.post_id">
        ğŸ§‘ ä½¿ç”¨è€… IDï¼š{{ post.user_id }}<br />
        âœï¸ å…§å®¹ï¼š{{ post.content }}<br />
        ğŸ•’ å»ºç«‹æ™‚é–“ï¼š{{ new Date(post.createdAt).toLocaleString() }}
        <hr />
      </li>
    </ul>

  </div>
</template>

<script setup>
// å¼•å…¥ Vue çš„å·¥å…·å‡½å¼èˆ‡ axios
import { ref, onMounted } from 'vue'
import axios from 'axios'

// JWTèªè­‰ç›¸é—œ
const registerName = ref('')
const registerEmail = ref('')
const registerPassword = ref('')
const loginEmail = ref('')
const loginPassword = ref('')
const authToken = ref('')

// è¨»å†Šç”¨æˆ¶
const register = async () => {
  try {
    const res = await axios.post('http://localhost:8080/api/auth/register', {
      name: registerName.value,
      email: registerEmail.value,
      password: registerPassword.value
    })
    authToken.value = res.data.token
    // æ¸…ç©ºè¼¸å…¥æ¬„ä½
    registerName.value = ''
    registerEmail.value = ''
    registerPassword.value = ''
    
    // è¨­ç½®å¾ŒçºŒè«‹æ±‚çš„æˆæ¬Šé ­
    axios.defaults.headers.common['Authorization'] = `Bearer ${authToken.value}`
    console.log('è¨­ç½®çš„Authorizationé ­:', `Bearer ${authToken.value}`)
    
    // æ›´æ–°è³‡æ–™
    fetchUsers()
    fetchPosts()
  } catch (error) {
    alert('è¨»å†Šå¤±æ•—ï¼š' + (error.response?.data?.error || error.message))
  }
}

// ç”¨æˆ¶ç™»å…¥
const login = async () => {
  try {
    const res = await axios.post('http://localhost:8080/api/auth/login', {
      email: loginEmail.value,
      password: loginPassword.value
    })
    authToken.value = res.data.token
    // æ¸…ç©ºè¼¸å…¥æ¬„ä½
    loginEmail.value = ''
    loginPassword.value = ''
    
    // è¨­ç½®å¾ŒçºŒè«‹æ±‚çš„æˆæ¬Šé ­
    axios.defaults.headers.common['Authorization'] = `Bearer ${authToken.value}`
    
    // æ›´æ–°è³‡æ–™
    fetchUsers()
    fetchPosts()
  } catch (error) {
    alert('ç™»å…¥å¤±æ•—ï¼š' + (error.response?.data?.error || error.message))
  }
}

// ç™»å‡ºåŠŸèƒ½
const logout = () => {
  authToken.value = ''
  // ç§»é™¤æˆæ¬Šé ­
  delete axios.defaults.headers.common['Authorization']
}

// æ‰€æœ‰ä½¿ç”¨è€…æ¸…å–®ï¼ˆé™£åˆ—ï¼‰
const users = ref([])

// æ‰€æœ‰è²¼æ–‡ï¼ˆé™£åˆ—ï¼‰
const posts = ref([])

// æ–°å¢ä½¿ç”¨è€…çš„è¼¸å…¥æ¬„ä½
const name = ref('')
const email = ref('')
const password = ref('')

// æ–°å¢è²¼æ–‡çš„æ¬„ä½
const user_id = ref('')
const content = ref('')
const creatd_at = ref('')

// ç·¨è¼¯ç‹€æ…‹èˆ‡æ¬„ä½
const editingUserId = ref(null)
const editName = ref('')
const editEmail = ref('')
const editPassword = ref('')

// ç•«é¢åˆå§‹åŒ–æ™‚å‘¼å«ï¼Œå–å¾—æ‰€æœ‰ä½¿ç”¨è€…
const fetchUsers = async () => {
  try {
    // ç¢ºä¿æ¯æ¬¡è«‹æ±‚éƒ½å¸¶ä¸Šæœ€æ–°çš„ä»¤ç‰Œ
    if (authToken.value) {
      axios.defaults.headers.common['Authorization'] = `Bearer ${authToken.value}`
    }

    const res = await axios.get('http://localhost:8080/users')
    users.value = res.data
    console.log('ç²å–ç”¨æˆ¶æˆåŠŸ:', res.data)
  } catch (error) {
    console.error('ç²å–ä½¿ç”¨è€…åˆ—è¡¨å¤±æ•—', error)
    if (error.response?.status === 403) {
      console.log('æˆæ¬Šå¤±æ•—ï¼Œç•¶å‰ä»¤ç‰Œ:', authToken.value)
    }
  }
}

// ç•«é¢æ›è¼‰ï¼ˆç¬¬ä¸€æ¬¡é–‹å•Ÿï¼‰æ™‚å‘¼å« fetchUsers
onMounted(fetchUsers)

// å»ºç«‹ä½¿ç”¨è€…ï¼ˆç™¼é€ POSTï¼‰
const createUser = async () => {
  await axios.post('http://localhost:8080/users', {
    name: name.value,
    email: email.value,
    password: password.value
  })
  name.value = ''
  email.value = ''
  password.value = ''
  fetchUsers()
}

// é–‹å§‹ç·¨è¼¯æŸä¸€ç­†è³‡æ–™ï¼ˆå¸¶å…¥åŸæœ¬å€¼ï¼‰
const startEdit = (user) => {
  editingUserId.value = user.id
  editName.value = user.name
  editEmail.value = user.email
  editPassword.value = user.password
}

// å–æ¶ˆç·¨è¼¯ï¼ˆæ¸…ç©ºæš«å­˜èˆ‡ç‹€æ…‹ï¼‰
const cancelEdit = () => {
  editingUserId.value = null
  editName.value = ''
  editEmail.value = ''
  editPassword.value = ''
}

// æ›´æ–°ä½¿ç”¨è€…ï¼ˆç™¼é€ PUTï¼‰
const updateUser = async (id) => {
  await axios.put(`http://localhost:8080/users/${id}`, {
    name: editName.value,
    email: editEmail.value,
    password: editPassword.value
  })
  editingUserId.value = null
  fetchUsers()
}

// åˆªé™¤ä½¿ç”¨è€…ï¼ˆç™¼é€ DELETEï¼‰
const deleteUser = async (id) => {
  await axios.delete(`http://localhost:8080/users/${id}`)
  fetchUsers()
}

// æ–°å¢è²¼æ–‡çš„æ¬„ä½
const postUserId = ref('')
const postContent = ref('')

// å–å¾—æ‰€æœ‰è²¼æ–‡
const fetchPosts = async () => {
  try {
    // ç¢ºä¿æ¯æ¬¡è«‹æ±‚éƒ½å¸¶ä¸Šæœ€æ–°çš„ä»¤ç‰Œ
    if (authToken.value) {
      axios.defaults.headers.common['Authorization'] = `Bearer ${authToken.value}`
    }
    
    const res = await axios.get('http://localhost:8080/posts')
    posts.value = res.data
    console.log('ç²å–è²¼æ–‡æˆåŠŸ:', res.data)
  } catch (error) {
    console.error('ç²å–è²¼æ–‡åˆ—è¡¨å¤±æ•—', error)
    if (error.response?.status === 403) {
      console.log('æˆæ¬Šå¤±æ•—ï¼Œç•¶å‰ä»¤ç‰Œ:', authToken.value)
    }
  }
}

// å»ºç«‹è²¼æ–‡
const createPost = async () => {
  await axios.post('http://localhost:8080/posts', {
    user_id: postUserId.value,
    content: postContent.value
  })
  postUserId.value = ''
  postContent.value = ''
  fetchPosts()
}

// ç•«é¢åˆå§‹åŒ–æ™‚ä¸€ä½µå–å¾—è²¼æ–‡
onMounted(() => {
  fetchUsers()
  fetchPosts()
})
</script> 

ä¿®æ”¹CONTROLLER

package com.example.demo.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.example.demo.model.User;
import com.example.demo.repository.UserRepository;

// ç§»é™¤èˆŠçš„CORSé…ç½®ï¼Œå› ç‚ºåœ¨WebConfigå’ŒSecurityConfigä¸­å·²å…¨å±€é…ç½®
// @CrossOrigin(origins = "*") 
@RestController
@RequestMapping("/users")
public class UserController {
    @Autowired
    private UserRepository userRepository;

    // æ–°å¢ä½¿ç”¨è€…
    @PostMapping
    public User createUser(@RequestBody User user) {
        return userRepository.save(user);
    }

    // æŸ¥è©¢æ‰€æœ‰ä½¿ç”¨è€…
    @GetMapping
    public List<User> getAllUsers() {
        List<User> users = userRepository.findAll();
        // å‡ºæ–¼å®‰å…¨è€ƒæ…®ï¼Œè¿”å›å‰æ¸…é™¤å¯†ç¢¼
        users.forEach(user -> user.setPassword(null));
        return users;
    }

    // æŸ¥è©¢å–®ä¸€
    @GetMapping("/{id}")
    public User getUserById(@PathVariable Long id) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("User not found"));
        // å‡ºæ–¼å®‰å…¨è€ƒæ…®ï¼Œè¿”å›å‰æ¸…é™¤å¯†ç¢¼
        user.setPassword(null);
        return user;
    }

    // åˆªé™¤å–®ä¸€
    @DeleteMapping("/{id}")
    public void deleteUser(@PathVariable Long id) {
        userRepository.deleteById(id);
    }

    // ä¿®æ”¹ä½¿ç”¨è€…
    @PutMapping("/{id}")
    public User updateUser(@PathVariable Long id, @RequestBody User updatedUser) {
        return userRepository.findById(id).map(user -> {
            user.setName(updatedUser.getName());
            user.setEmail(updatedUser.getEmail());
            if (updatedUser.getPassword() != null && !updatedUser.getPassword().isEmpty()) {
                user.setPassword(updatedUser.getPassword());
            }
            User savedUser = userRepository.save(user);
            // å‡ºæ–¼å®‰å…¨è€ƒæ…®ï¼Œè¿”å›å‰æ¸…é™¤å¯†ç¢¼
            savedUser.setPassword(null);
            return savedUser;
        }).orElseThrow(() -> new RuntimeException("User not found"));
    }
}

POSTä¿®æ”¹
package com.example.demo.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.example.demo.model.Post;
import com.example.demo.repository.PostRepository;

// ç§»é™¤ç¨ç«‹CORSé…ç½®ï¼Œä½¿ç”¨å…¨å±€é…ç½®
// @CrossOrigin(origins = "*")
@RestController
@RequestMapping("/posts")
public class PostController {
    @Autowired
    private PostRepository postRepository;

    // æ–°å¢è²¼æ–‡
    @PostMapping
    public Post createPost(@RequestBody Post post) {
        return postRepository.save(post);
    }

    // æŸ¥è©¢æ‰€æœ‰ä½¿ç”¨è€…
    @GetMapping
    public List<Post> getAllPosts() {
        return postRepository.findAll();
    }

    // æŸ¥è©¢å–®ä¸€
    @GetMapping("/{id}")
    public Post getPostById(@PathVariable Long id) {
        return postRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Post not found"));
    }

    // åˆªé™¤å–®ä¸€
    @DeleteMapping("/{id}")
    public void deletePost(@PathVariable Long id) {
        postRepository.deleteById(id);
    }

    // ä¿®æ”¹ä½¿ç”¨è€…
    @PutMapping("/{id}")
    public Post updatePost(@PathVariable Long id, @RequestBody Post updatedPost) {
        return postRepository.findById(id).map(post -> {
            post.setContent(updatedPost.getContent());
            return postRepository.save(post);
        }).orElseThrow(() -> new RuntimeException("Post not found"));
    }
}


******ä¿®æ”¹JwtAuthenticationFilter

package com.example.demo.security;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.logging.Logger;

@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private static final Logger LOGGER = Logger.getLogger(JwtAuthenticationFilter.class.getName());

    @Autowired
    private JwtUtil jwtUtil;

    @Autowired
    private UserDetailsService userDetailsService;

    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain) throws ServletException, IOException {

        final String authHeader = request.getHeader("Authorization");
        final String requestURI = request.getRequestURI();

        LOGGER.info("è™•ç†è«‹æ±‚: " + requestURI + " å¸¶æˆæ¬Šé ­: " + (authHeader != null));

        // å¦‚æœè«‹æ±‚æ˜¯/api/authé–‹é ­çš„æˆ–è€…æ˜¯OPTIONSè«‹æ±‚ï¼Œå‰‡ç›´æ¥æ”¾è¡Œ
        if (requestURI.startsWith("/api/auth/") || request.getMethod().equals("OPTIONS")) {
            LOGGER.info("æ”¾è¡Œèªè­‰è·¯å¾‘æˆ–OPTIONSè«‹æ±‚: " + requestURI);
            filterChain.doFilter(request, response);
            return;
        }

        final String jwt;
        final String userEmail;

        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            LOGGER.warning("æˆæ¬Šé ­ç¼ºå¤±æˆ–æ ¼å¼éŒ¯èª¤: " + (authHeader == null ? "null" : authHeader));
            filterChain.doFilter(request, response);
            return;
        }

        jwt = authHeader.substring(7);

        try {
            userEmail = jwtUtil.extractUsername(jwt);

            LOGGER.info("JWTä»¤ç‰Œæœ‰æ•ˆï¼Œæå–çš„ç”¨æˆ¶éƒµç®±: " + userEmail);

            if (userEmail != null && SecurityContextHolder.getContext().getAuthentication() == null) {
                UserDetails userDetails = this.userDetailsService.loadUserByUsername(userEmail);

                if (jwtUtil.validateToken(jwt, userDetails)) {
                    LOGGER.info("JWTä»¤ç‰Œé©—è­‰æˆåŠŸï¼Œè¨­ç½®èªè­‰ä¸Šä¸‹æ–‡");

                    UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                            userDetails,
                            null,
                            userDetails.getAuthorities());
                    authToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                    SecurityContextHolder.getContext().setAuthentication(authToken);
                } else {
                    LOGGER.warning("JWTä»¤ç‰Œç„¡æ•ˆ");
                }
            }
        } catch (Exception e) {
            LOGGER.severe("è™•ç†JWTä»¤ç‰Œæ™‚ç™¼ç”ŸéŒ¯èª¤: " + e.getMessage());
        }

        filterChain.doFilter(request, response);
    }
}


******ä¿®æ”¹application


spring.application.name=bbb

# databaseé…ç½®
spring.datasource.url=jdbc:sqlserver://localhost:1433;databaseName=bbb;encrypt=false;characterEncoding=UTF-8
spring.datasource.username=bbb
spring.datasource.password=bbb
spring.datasource.driver-class-name=com.microsoft.sqlserver.jdbc.SQLServerDriver


# JPA/Hibernate é…ç½®
spring.jpa.database-platform=org.hibernate.dialect.SQLServerDialect
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true

# serveré…ç½®
server.port=8080

# JWTé…ç½®
jwt.secret=7DwAPKpz9h2wR4fVkRuNnGtWYT7A5LSBq8Xe3vDFGJjsUQZXyYRPLnHMTcVb
jwt.expiration=86400000

# æ—¥èªŒé…ç½®
logging.level.org.springframework.security=DEBUG
logging.level.com.example.demo.security=DEBUG


******ä¿®æ”¹SECUITY


package com.example.demo.config;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import com.example.demo.security.JwtAuthenticationFilter;

import java.util.Arrays;
import java.util.Collections;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Autowired
    private JwtAuthenticationFilter jwtAuthFilter;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                // å•Ÿç”¨CORSæ”¯æŒ
                .cors(cors -> cors.configurationSource(corsConfigurationSource()))
                // ç¦ç”¨CSRFä¿è­·
                .csrf(csrf -> csrf.disable())
                // é…ç½®æˆæ¬Šè¦å‰‡
                .authorizeHttpRequests(auth -> auth
                        // å…è¨±æ‰€æœ‰äººè¨ªå•èªè­‰API
                        .requestMatchers("/api/auth/**").permitAll()
                        // è‡¨æ™‚å…è¨±æ‰€æœ‰è¨ªå•ï¼Œè§£æ±ºç•¶å‰å•é¡Œ
                        .requestMatchers("/users/**", "/posts/**").permitAll()
                        // å…¶ä»–æ‰€æœ‰è«‹æ±‚éœ€è¦èªè­‰
                        .anyRequest().authenticated())
                // è¨­ç½®ç„¡ç‹€æ…‹æœƒè©±ï¼ˆJWTä½¿ç”¨ï¼‰
                .sessionManagement(session -> session
                        .sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                // æ·»åŠ JWTéæ¿¾å™¨
                .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Collections.singletonList("http://localhost:5173"));
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS", "HEAD"));
        configuration.setAllowedHeaders(Arrays.asList("Authorization", "Content-Type", "X-Requested-With"));
        configuration.setExposedHeaders(Arrays.asList("Authorization"));
        configuration.setAllowCredentials(true);
        configuration.setMaxAge(3600L);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }
}


******ä¿®æ”¹å‰ç«¯


<template>
  <div style="padding: 20px">
    <!-- è¨»å†Šèˆ‡ç™»å…¥å€å¡Š -->
    <h2 style="margin-top: 30px">ç”¨æˆ¶è¨»å†Š</h2>
    <input v-model="registerName" placeholder="å§“å" />
    <input v-model="registerEmail" placeholder="Email" />
    <input v-model="registerPassword" placeholder="å¯†ç¢¼" />
    <button @click="register">è¨»å†Š</button>
    
    <h2 style="margin-top: 30px">ç”¨æˆ¶ç™»å…¥</h2>
    <input v-model="loginEmail" placeholder="Email" />
    <input v-model="loginPassword" placeholder="å¯†ç¢¼" />
    <button @click="login">ç™»å…¥</button>
    
    <div v-if="authToken" style="margin-top: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
      <p>å·²ç™»å…¥æˆåŠŸï¼</p>
      <p>Token: {{ authToken.substring(0, 20) }}...</p>
      <button @click="logout">ç™»å‡º</button>
    </div>

    <h1>ä½¿ç”¨è€…æ¸…å–®</h1>
    <ul>
      <!-- v-for è¿´åœˆæ¸²æŸ“æ¯å€‹ä½¿ç”¨è€… -->
      <li v-for="user in users" :key="user.id">
        <!-- è‹¥è©²ä½¿ç”¨è€…æ­£åœ¨ç·¨è¼¯ï¼Œé¡¯ç¤ºè¼¸å…¥æ¡† -->
        <template v-if="editingUserId === user.id">
          <input v-model="editName" placeholder="å§“å" />
          <input v-model="editEmail" placeholder="Email" />
          <input v-model="editPassword" placeholder="å¯†ç¢¼" />
          <button @click="updateUser(user.id)">å„²å­˜</button>
          <button @click="cancelEdit">å–æ¶ˆ</button>
        </template>
        <!-- å¦å‰‡é¡¯ç¤ºä¸€èˆ¬è³‡è¨Šèˆ‡æ“ä½œæŒ‰éˆ• -->
        <template v-else>
          {{ user.name }} - {{ user.email }}
          <button @click="startEdit(user)">ç·¨è¼¯</button>
          <button @click="deleteUser(user.id)">åˆªé™¤</button>
        </template>
      </li>
    </ul>

    <!-- æ–°å¢ä½¿ç”¨è€…å€å¡Š -->
    <h2 style="margin-top: 30px">æ–°å¢ä½¿ç”¨è€…</h2>
    <input v-model="name" placeholder="å§“å" />
    <input v-model="email" placeholder="Email" />
    <input v-model="password" placeholder="å¯†ç¢¼" />
    <button @click="createUser">é€å‡º</button>

    <!-- æ–°å¢è²¼æ–‡å€å¡Š -->
    <h2 style="margin-top: 30px">æ–°å¢è²¼æ–‡</h2>
    <input v-model="postUserId" placeholder="ä½¿ç”¨è€… ID" />
    <input v-model="postContent" placeholder="è²¼æ–‡å…§å®¹" />
    <button @click="createPost">é€å‡º</button>

    <h2 style="margin-top: 30px">è²¼æ–‡åˆ—è¡¨</h2>
    <ul>
      <li v-for="post in posts" :key="post.post_id">
        ğŸ§‘ ä½¿ç”¨è€… IDï¼š{{ post.user_id }}<br />
        âœï¸ å…§å®¹ï¼š{{ post.content }}<br />
        ğŸ•’ å»ºç«‹æ™‚é–“ï¼š{{ new Date(post.createdAt).toLocaleString() }}
        <hr />
      </li>
    </ul>

  </div>
</template>

<script setup>
// å¼•å…¥ Vue çš„å·¥å…·å‡½å¼èˆ‡ axios
import { ref, onMounted } from 'vue'
import axios from 'axios'

// JWTèªè­‰ç›¸é—œ
const registerName = ref('')
const registerEmail = ref('')
const registerPassword = ref('')
const loginEmail = ref('')
const loginPassword = ref('')
const authToken = ref('')

// è¨»å†Šç”¨æˆ¶
const register = async () => {
  try {
    const res = await axios.post('http://localhost:8080/api/auth/register', {
      name: registerName.value,
      email: registerEmail.value,
      password: registerPassword.value
    })
    authToken.value = res.data.token
    
    // ä¿å­˜ä»¤ç‰Œåˆ°æœ¬åœ°å­˜å„²ï¼Œä»¥ä¾¿é é¢é‡è¼‰å¾Œä¿æŒç™»å…¥
    localStorage.setItem('jwtToken', authToken.value)
    
    // æ¸…ç©ºè¼¸å…¥æ¬„ä½
    registerName.value = ''
    registerEmail.value = ''
    registerPassword.value = ''
    
    // è¨­ç½®å…¨å±€é»˜èªæˆæ¬Šé ­
    setAuthHeader(authToken.value)
    console.log('è¨­ç½®çš„Authorizationé ­:', `Bearer ${authToken.value}`)
    
    // æ›´æ–°è³‡æ–™
    fetchUsers()
    fetchPosts()
  } catch (error) {
    alert('è¨»å†Šå¤±æ•—ï¼š' + (error.response?.data?.error || error.message))
    console.error('è¨»å†ŠéŒ¯èª¤è©³æƒ…:', error)
  }
}

// ç”¨æˆ¶ç™»å…¥
const login = async () => {
  try {
    const res = await axios.post('http://localhost:8080/api/auth/login', {
      email: loginEmail.value,
      password: loginPassword.value
    })
    authToken.value = res.data.token
    
    // ä¿å­˜ä»¤ç‰Œåˆ°æœ¬åœ°å­˜å„²
    localStorage.setItem('jwtToken', authToken.value)
    
    // æ¸…ç©ºè¼¸å…¥æ¬„ä½
    loginEmail.value = ''
    loginPassword.value = ''
    
    // è¨­ç½®æˆæ¬Šé ­
    setAuthHeader(authToken.value)
    console.log('è¨­ç½®çš„Authorizationé ­:', `Bearer ${authToken.value}`)
    
    // æ›´æ–°è³‡æ–™
    fetchUsers()
    fetchPosts()
  } catch (error) {
    alert('ç™»å…¥å¤±æ•—ï¼š' + (error.response?.data?.error || error.message))
    console.error('ç™»å…¥éŒ¯èª¤è©³æƒ…:', error)
  }
}

// ç™»å‡ºåŠŸèƒ½
const logout = () => {
  authToken.value = ''
  // ç§»é™¤æœ¬åœ°å­˜å„²ä¸­çš„ä»¤ç‰Œ
  localStorage.removeItem('jwtToken')
  // ç§»é™¤æˆæ¬Šé ­
  delete axios.defaults.headers.common['Authorization']
}

// è¼”åŠ©å‡½æ•¸ï¼šè¨­ç½®èªè­‰é ­
const setAuthHeader = (token) => {
  if (token) {
    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`
  } else {
    delete axios.defaults.headers.common['Authorization']
  }
}

// å•Ÿå‹•æ™‚æª¢æŸ¥æœ¬åœ°å­˜å„²ä¸­çš„ä»¤ç‰Œ
const checkSavedToken = () => {
  const savedToken = localStorage.getItem('jwtToken')
  if (savedToken) {
    authToken.value = savedToken
    setAuthHeader(savedToken)
    console.log('å¾æœ¬åœ°å­˜å„²æ¢å¾©çš„ä»¤ç‰Œ:', savedToken)
  }
}

// æ‰€æœ‰ä½¿ç”¨è€…æ¸…å–®ï¼ˆé™£åˆ—ï¼‰
const users = ref([])

// æ‰€æœ‰è²¼æ–‡ï¼ˆé™£åˆ—ï¼‰
const posts = ref([])

// æ–°å¢ä½¿ç”¨è€…çš„è¼¸å…¥æ¬„ä½
const name = ref('')
const email = ref('')
const password = ref('')

// æ–°å¢è²¼æ–‡çš„æ¬„ä½
const user_id = ref('')
const content = ref('')
const creatd_at = ref('')

// ç·¨è¼¯ç‹€æ…‹èˆ‡æ¬„ä½
const editingUserId = ref(null)
const editName = ref('')
const editEmail = ref('')
const editPassword = ref('')

// å–å¾—æ‰€æœ‰ä½¿ç”¨è€…
const fetchUsers = async () => {
  try {
    console.log('ç™¼é€ç²å–ç”¨æˆ¶è«‹æ±‚ï¼Œæˆæ¬Šé ­:', axios.defaults.headers.common['Authorization'])
    
    // å‰µå»ºæ˜ç¢ºå¸¶æœ‰æˆæ¬Šé ­çš„è«‹æ±‚é…ç½®
    const config = {
      headers: { Authorization: `Bearer ${authToken.value}` }
    }
    
    const res = await axios.get('http://localhost:8080/users', config)
    users.value = res.data
    console.log('ç²å–ç”¨æˆ¶æˆåŠŸ:', res.data)
  } catch (error) {
    console.error('ç²å–ä½¿ç”¨è€…åˆ—è¡¨å¤±æ•—', error)
    if (error.response?.status === 403) {
      console.log('æˆæ¬Šå¤±æ•—ï¼Œç•¶å‰ä»¤ç‰Œ:', authToken.value)
    }
  }
}

// ç•«é¢æ›è¼‰ï¼ˆç¬¬ä¸€æ¬¡é–‹å•Ÿï¼‰æ™‚å‘¼å« fetchUsers
onMounted(fetchUsers)

// å»ºç«‹ä½¿ç”¨è€…ï¼ˆç™¼é€ POSTï¼‰
const createUser = async () => {
  await axios.post('http://localhost:8080/users', {
    name: name.value,
    email: email.value,
    password: password.value
  })
  name.value = ''
  email.value = ''
  password.value = ''
  fetchUsers()
}

// é–‹å§‹ç·¨è¼¯æŸä¸€ç­†è³‡æ–™ï¼ˆå¸¶å…¥åŸæœ¬å€¼ï¼‰
const startEdit = (user) => {
  editingUserId.value = user.id
  editName.value = user.name
  editEmail.value = user.email
  editPassword.value = user.password
}

// å–æ¶ˆç·¨è¼¯ï¼ˆæ¸…ç©ºæš«å­˜èˆ‡ç‹€æ…‹ï¼‰
const cancelEdit = () => {
  editingUserId.value = null
  editName.value = ''
  editEmail.value = ''
  editPassword.value = ''
}

// æ›´æ–°ä½¿ç”¨è€…ï¼ˆç™¼é€ PUTï¼‰
const updateUser = async (id) => {
  await axios.put(`http://localhost:8080/users/${id}`, {
    name: editName.value,
    email: editEmail.value,
    password: editPassword.value
  })
  editingUserId.value = null
  fetchUsers()
}

// åˆªé™¤ä½¿ç”¨è€…ï¼ˆç™¼é€ DELETEï¼‰
const deleteUser = async (id) => {
  await axios.delete(`http://localhost:8080/users/${id}`)
  fetchUsers()
}

// æ–°å¢è²¼æ–‡çš„æ¬„ä½
const postUserId = ref('')
const postContent = ref('')

// å–å¾—æ‰€æœ‰è²¼æ–‡
const fetchPosts = async () => {
  try {
    console.log('ç™¼é€ç²å–è²¼æ–‡è«‹æ±‚ï¼Œæˆæ¬Šé ­:', axios.defaults.headers.common['Authorization'])
    
    // å‰µå»ºæ˜ç¢ºå¸¶æœ‰æˆæ¬Šé ­çš„è«‹æ±‚é…ç½®
    const config = {
      headers: { Authorization: `Bearer ${authToken.value}` }
    }
    
    const res = await axios.get('http://localhost:8080/posts', config)
    posts.value = res.data
    console.log('ç²å–è²¼æ–‡æˆåŠŸ:', res.data)
  } catch (error) {
    console.error('ç²å–è²¼æ–‡åˆ—è¡¨å¤±æ•—', error)
    if (error.response?.status === 403) {
      console.log('æˆæ¬Šå¤±æ•—ï¼Œç•¶å‰ä»¤ç‰Œ:', authToken.value)
    }
  }
}

// å»ºç«‹è²¼æ–‡
const createPost = async () => {
  await axios.post('http://localhost:8080/posts', {
    user_id: postUserId.value,
    content: postContent.value
  })
  postUserId.value = ''
  postContent.value = ''
  fetchPosts()
}

// é é¢æ›è¼‰æ™‚
onMounted(() => {
  // æª¢æŸ¥ä¿å­˜çš„ä»¤ç‰Œ
  checkSavedToken()
  // ç²å–è³‡æ–™
  fetchUsers()
  fetchPosts()
})
</script> 
